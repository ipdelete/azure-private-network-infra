#!/bin/bash

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“¦ Complete Azure Private Network Infrastructure Deployment
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# This script deploys the entire secure Azure infrastructure:
# â€¢ Resource Group
# â€¢ Virtual Network with NAT Gateway and NSGs  
# â€¢ Storage Account with Private Endpoint
# â€¢ NFS 4.1 File Share
# â€¢ Red Hat Linux VM with automated NFS mounting
# â€¢ Azure Bastion Host for secure access

set -e  # Exit on any error

# ğŸ”§ Configuration
LOCATION="eastus2"
BICEP_FILE="main.bicep"
PARAM_FILE="main.parameters.json"
DEPLOYMENT_NAME="complete-infra-deploy-$(date +%s)"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸš€ Azure Private Network Infrastructure Deployment${NC}"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ“… Started at: $(date)"
echo "ğŸ“ Location: $LOCATION"
echo "ğŸ“‹ Deployment Name: $DEPLOYMENT_NAME"
echo ""

# Check if SSH key is configured
if grep -q "YOUR_SSH_PUBLIC_KEY_HERE" "$PARAM_FILE"; then
    echo -e "${RED}âŒ SSH public key not configured!${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ“ Please follow these steps:${NC}"
    echo "1. Generate SSH keys (if needed):"
    echo "   cd ../vm/ && ./generate-ssh-key.sh"
    echo ""
    echo "2. Update the SSH public key in $PARAM_FILE:"
    echo "   Replace 'YOUR_SSH_PUBLIC_KEY_HERE' with your actual SSH public key"
    echo ""
    echo "3. Re-run this deployment script"
    echo ""
    exit 1
fi

echo -e "${YELLOW}âš ï¸  Important Notes:${NC}"
echo "â€¢ This deployment will take approximately 15-20 minutes"
echo "â€¢ Azure Bastion deployment is the longest step (~10-15 minutes)"
echo "â€¢ All resources will be created in a new resource group"
echo "â€¢ The VM will automatically mount the NFS share via cloud-init"
echo ""

# Confirmation prompt
read -p "ğŸ¤” Continue with deployment? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ Deployment cancelled."
    exit 0
fi

echo ""
echo -e "${BLUE}ğŸš€ Starting deployment...${NC}"

# Run the deployment
az deployment sub create \
  --template-file "$BICEP_FILE" \
  --parameters "$PARAM_FILE" \
  --location "$LOCATION" \
  --name "$DEPLOYMENT_NAME" \
  --verbose

# Check deployment result
if [ $? -eq 0 ]; then
    echo ""
    echo -e "${GREEN}âœ… Deployment completed successfully!${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # Get deployment outputs
    echo -e "${BLUE}ğŸ“Š Deployment Summary:${NC}"
    az deployment sub show \
      --name "$DEPLOYMENT_NAME" \
      --query "properties.outputs" \
      --output json | jq -r '
        "ğŸ—ï¸  Resource Group: " + .resourceGroupName.value,
        "ğŸŒ Virtual Network: " + .vnetName.value,
        "ğŸ’¾ Storage Account: " + .storageAccountName.value,
        "ğŸ“ NFS Share: " + .nfsShareName.value,
        "ğŸ’» Virtual Machine: " + .vmName.value + " (" + .vmPrivateIPAddress.value + ")",
        "ğŸ° Bastion Host: " + .bastionHostName.value + " (" + .bastionPublicIpAddress.value + ")"
      '
    
    echo ""
    echo -e "${GREEN}ğŸ”— Access Instructions:${NC}"
    echo "1. Navigate to the Azure Portal"
    echo "2. Go to Virtual Machines â†’ vm-pi-localdev"
    echo "3. Click 'Connect' â†’ 'Bastion'"
    echo "4. Use SSH authentication:"
    echo "   â€¢ Username: azureuser"
    echo "   â€¢ Authentication: SSH Private Key"
    echo "   â€¢ Private Key: Use the key generated by vm/generate-ssh-key.sh"
    
    echo ""
    echo -e "${GREEN}ğŸ“ NFS Share Access:${NC}"
    STORAGE_NAME=$(az deployment sub show --name "$DEPLOYMENT_NAME" --query "properties.outputs.storageAccountName.value" -o tsv)
    echo "â€¢ NFS share automatically mounted at: /mount/$STORAGE_NAME/nfsshare"
    echo "â€¢ Test access: ls -la /mount/$STORAGE_NAME/nfsshare"
    echo "â€¢ Test write: echo 'Hello' > /mount/$STORAGE_NAME/nfsshare/test.txt"
    
    echo ""
    echo -e "${GREEN}ğŸ” Validation Commands (run on VM):${NC}"
    echo "â€¢ Cloud-init status: sudo cloud-init status"
    echo "â€¢ NFS mount check: df -h | grep nfs"
    echo "â€¢ View cloud-init logs: sudo cat /var/log/cloud-init.log"
    
    echo ""
    echo -e "${YELLOW}ğŸ§¹ Cleanup (when done):${NC}"
    echo "â€¢ Run: ../scripts/cleanup.sh"
    echo "â€¢ Or manually: az group delete --name aet-pi-localdev-es2-tst4 --yes"
    
else
    echo ""
    echo -e "${RED}âŒ Deployment failed!${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ” Troubleshooting steps:${NC}"
    echo "1. Check Azure CLI authentication: az account show"
    echo "2. Verify subscription permissions for resource creation"
    echo "3. Check deployment logs:"
    echo "   az deployment sub show --name $DEPLOYMENT_NAME --query properties.error"
    echo "4. For detailed error information:"
    echo "   az deployment sub list --query \"[?name=='$DEPLOYMENT_NAME']\" --output table"
    
    exit 1
fi

echo ""
echo "ğŸ“… Completed at: $(date)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
